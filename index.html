<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯ÙˆØ² Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ†</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #6366f1; --secondary: #ec4899; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; }
        * { box-sizing: border-box; transition: all 0.2s ease; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { width: 95%; max-width: 450px; background: var(--card); padding: 25px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 1px solid #334155; position: relative; text-align: center; }
        .hidden { display: none !important; }
        
        input { width: 100%; padding: 15px; margin: 15px 0; border-radius: 12px; border: 2px solid #334155; background: #0f172a; color: white; font-size: 1rem; text-align: center; }
        .menu-btn { width: 100%; padding: 16px; margin: 8px 0; border: none; border-radius: 14px; background: var(--primary); color: white; font-size: 1.1rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .menu-btn:hover { filter: brightness(1.2); transform: translateY(-2px); }
        
        .board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 20px 0; }
        .cell { aspect-ratio: 1; background: #334155; border-radius: 16px; display: flex; justify-content: center; align-items: center; font-size: 3rem; font-weight: 800; cursor: pointer; }
        .cell.x { color: #60a5fa; text-shadow: 0 0 15px #60a5fa; }
        .cell.o { color: #f472b6; text-shadow: 0 0 15px #f472b6; }

        .status-bar { display: flex; justify-content: space-between; align-items: center; background: #0f172a; padding: 12px; border-radius: 15px; margin-bottom: 15px; border: 1px solid #334155; }
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ ÙˆØ³Ø·â€ŒÚ†ÛŒÙ† Ú©Ø±Ø¯Ù† ÙˆØ¶Ø¹ÛŒØª Ù†ÙˆØ¨Øª */
        #game-status { flex-grow: 1; text-align: center; font-weight: bold; color: var(--primary); font-size: 0.9rem; padding: 0 5px; }
        
        .room-item { background: #0f172a; padding: 12px; margin: 8px 0; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #475569; text-align: right; }
        .room-code { font-family: 'Courier New', monospace; background: #334155; padding: 2px 8px; border-radius: 5px; color: #fbbf24; font-weight: bold; }
        #result-overlay { background: rgba(15, 23, 42, 0.95); border-radius: 24px; padding: 30px; border: 2px solid var(--primary); }
    </style>
</head>
<body>

<div class="container">
    <div id="login-screen">
        <h2>ğŸ® Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯</h2>
        <input type="text" id="username-input" placeholder="Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯...">
        <button class="menu-btn" onclick="login()">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¯Ù†ÛŒØ§ÛŒ Ø¨Ø§Ø²ÛŒ</button>
    </div>

    <div id="menu-screen" class="hidden">
        <h3 id="welcome-msg"></h3>
        <button class="menu-btn" onclick="showLobby()" style="background: #6366f1;">ğŸŒ Ø¨Ø§Ø²ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ†</button>
        <button class="menu-btn" onclick="startOffline()" style="background: #10b981;">ğŸ‘¥ Ø¨Ø§Ø²ÛŒ Ø¢ÙÙ„Ø§ÛŒÙ† (Ø¯Ùˆ Ù†ÙØ±Ù‡)</button>
        <button class="menu-btn" onclick="showAiLevels()" style="background: #f59e0b;">ğŸ¤– Ø¨Ø§Ø²ÛŒ Ø¨Ø§ Ø±Ø¨Ø§Øª</button>
    </div>

    <div id="ai-screen" class="hidden">
        <h3>Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø·Ø­ Ø³Ø®ØªÛŒ</h3>
        <button class="menu-btn" onclick="startAi('easy')">Ø¢Ø³Ø§Ù†</button>
        <button class="menu-btn" onclick="startAi('medium')">Ù…ØªÙˆØ³Ø·</button>
        <button class="menu-btn" onclick="startAi('hard')">Ø³Ø®Øª</button>
        <button class="menu-btn" onclick="backToMenu()" style="background:#475569">Ø¨Ø±Ú¯Ø´Øª</button>
    </div>

    <div id="lobby-screen" class="hidden">
        <h3>Ø§ØªØ§Ù‚â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„</h3>
        <div id="room-list" style="max-height: 200px; overflow-y: auto; margin-bottom: 10px;"></div>
        <button class="menu-btn" onclick="createOnlineRoom()">â• Ø³Ø§Ø®Øª Ø§ØªØ§Ù‚ Ø¬Ø¯ÛŒØ¯</button>
        <button class="menu-btn" onclick="backToMenu()" style="background:#475569">Ø¨Ø±Ú¯Ø´Øª</button>
    </div>

    <div id="game-screen" class="hidden">
        <div id="timer-box" style="font-size: 0.9rem; margin-bottom: 5px;">Ø²Ù…Ø§Ù† Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: <span id="sec">30</span>s</div>
        <div class="status-bar">
            <div style="width: 80px; text-align: right;"><small id="p1-name-display">Ø¨Ø§Ø²ÛŒÚ©Ù† Û±</small><br><span id="p1-score" style="font-size:1.5rem">0</span></div>
            <div id="game-status">Ø¯Ø±Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...</div>
            <div style="width: 80px; text-align: left;"><small id="p2-name-display">Ø¨Ø§Ø²ÛŒÚ©Ù† Û²</small><br><span id="p2-score" style="font-size:1.5rem">0</span></div>
        </div>
        <div class="board" id="board">
            <div class="cell" onclick="handleMove(0)"></div><div class="cell" onclick="handleMove(1)"></div><div class="cell" onclick="handleMove(2)"></div>
            <div class="cell" onclick="handleMove(3)"></div><div class="cell" onclick="handleMove(4)"></div><div class="cell" onclick="handleMove(5)"></div>
            <div class="cell" onclick="handleMove(6)"></div><div class="cell" onclick="handleMove(7)"></div><div class="cell" onclick="handleMove(8)"></div>
        </div>
        <div id="round-info">Ø±Ø§Ù†Ø¯: 1 / 5</div>
        <button class="menu-btn" onclick="backToMenu()" style="background:#475569; font-size:0.9rem; padding:12px; margin-top: 10px;">ğŸ  Ø®Ø±ÙˆØ¬ Ø§Ø² Ø¨Ø§Ø²ÛŒ</button>
    </div>

    <div id="result-screen" class="hidden">
        <div id="result-overlay">
            <h2 id="winner-text" style="color: var(--secondary);">Ù¾Ø§ÛŒØ§Ù† Ù†Ø¨Ø±Ø¯!</h2>
            <div id="final-scores" style="font-size: 1.2rem; margin: 20px 0;"></div>
            <button class="menu-btn" onclick="backToMenu()">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†Ùˆ</button>
        </div>
    </div>
</div>

<script>
    const SB_URL = 'https://kbtvvcbgnvohlxncfjdu.supabase.co';
    const SB_KEY = 'sb_publishable_1S4Ogjebi8k6P7VJZ3te4g_cmub4ub9';
    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

    let currentUser = "", gameMode = "", board = Array(9).fill(""), currentPlayer = "X";
    let scores = { X: 0, O: 0 }, rounds = 1, currentRoomId = null, mySymbol = "X", moveTimer = null, aiLevel = 'easy';
    let p1Name = "Ø¨Ø§Ø²ÛŒÚ©Ù† 1", p2Name = "Ø¨Ø§Ø²ÛŒÚ©Ù† 2";

    // ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† Ù†Ø§Ù… Ø¨Ù‡ 10 Ú©Ø§Ø±Ø§Ú©ØªØ±
    function limitStr(str, limit = 10) {
        if (!str) return str;
        return str.length > limit ? str.substring(0, limit) + "..." : str;
    }

    function login() {
        const input = document.getElementById('username-input').value.trim();
        if(!input) return alert("Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
        currentUser = input;
        showScreen('menu-screen');
        document.getElementById('welcome-msg').innerText = `Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØŒ ${limitStr(currentUser)}`;
    }

    function showScreen(id) {
        document.querySelectorAll('.container > div').forEach(d => d.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        if(id !== 'game-screen') clearInterval(moveTimer);
    }

    function backToMenu() {
        if(currentRoomId && gameMode === "online") closeRoom();
        showScreen('menu-screen');
        resetScores();
    }

    async function closeRoom() {
        await supabaseClient.from('rooms').update({ is_active: false }).eq('id', currentRoomId);
        supabaseClient.channel(`room:${currentRoomId}`).unsubscribe();
        currentRoomId = null;
    }

    async function handleMove(i) {
        if (board[i] !== "" || checkWinner(board)) return;
        if (gameMode === "online" && (currentPlayer !== mySymbol || !p2Name)) return;
        board[i] = currentPlayer;
        renderBoard();
        const winSymbol = checkWinner(board);
        if (winSymbol) {
            scores[winSymbol]++;
            if(gameMode === "online") await syncMove();
            processRoundEnd();
        } else if (!board.includes("")) {
            processRoundEnd();
        } else {
            currentPlayer = (currentPlayer === "X") ? "O" : "X";
            startTimer();
            if(gameMode === "online") await syncMove();
            if(gameMode === "ai" && currentPlayer === "O") setTimeout(makeAiMove, 500);
        }
    }

    function makeAiMove() {
        const avail = board.map((v,i) => v===""?i:null).filter(v=>v!==null);
        let idx = avail[Math.floor(Math.random()*avail.length)];
        handleMove(idx);
    }

    function startTimer() {
        clearInterval(moveTimer);
        let s = 30; document.getElementById('sec').innerText = s;
        moveTimer = setInterval(() => {
            s--; document.getElementById('sec').innerText = s;
            if(s <= 0) {
                clearInterval(moveTimer);
                let winner = (currentPlayer === "X") ? "O" : "X";
                alert(`Ø²Ù…Ø§Ù† Ø¨Ø§Ø²ÛŒÚ©Ù† ${limitStr(currentPlayer === "X" ? p1Name : p2Name)} ØªÙ…Ø§Ù… Ø´Ø¯!`);
                scores[winner] = 5;
                showFinalResult();
            }
        }, 1000);
    }

    function processRoundEnd() {
        clearInterval(moveTimer);
        if(rounds >= 5) showFinalResult();
        else { rounds++; document.getElementById('round-info').innerText = `Ø±Ø§Ù†Ø¯: ${rounds} / 5`; setTimeout(resetGame, 1200); }
    }

    function showFinalResult(exitWin = false) {
        clearInterval(moveTimer);
        const winnerText = document.getElementById('winner-text');
        const scoresText = document.getElementById('final-scores');
        let msg = "";
        if (exitWin) msg = "ğŸ† Ø­Ø±ÛŒÙ Ø®Ø§Ø±Ø¬ Ø´Ø¯! Ø´Ù…Ø§ Ø¨Ø±Ù†Ø¯Ù‡ Ø´Ø¯ÛŒØ¯.";
        else msg = (scores.X > scores.O) ? `ğŸ† Ø¨Ø±Ù†Ø¯Ù‡ Ù†Ù‡Ø§ÛŒÛŒ: ${limitStr(p1Name)}` : (scores.O > scores.X ? `ğŸ† Ø¨Ø±Ù†Ø¯Ù‡ Ù†Ù‡Ø§ÛŒÛŒ: ${limitStr(p2Name)}` : "ğŸ¤ Ø¨Ø§Ø²ÛŒ Ù…Ø³Ø§ÙˆÛŒ Ø´Ø¯!");
        winnerText.innerText = msg;
        scoresText.innerText = `Ø§Ù…ØªÛŒØ§Ø² Ù†Ù‡Ø§ÛŒÛŒ\n${limitStr(p1Name)}: ${scores.X} | ${limitStr(p2Name) || '...'}: ${scores.O}`;
        showScreen('result-screen');
    }

    function checkWinner(b) {
        const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
        const win = wins.find(c => b[c[0]] && b[c[0]] === b[c[1]] && b[c[0]] === b[c[2]]);
        return win ? b[win[0]] : null;
    }

    function renderBoard() {
        const cells = document.querySelectorAll('.cell');
        board.forEach((v, i) => { cells[i].innerText = v; cells[i].className = `cell ${v.toLowerCase()}`; });
        document.getElementById('p1-score').innerText = scores.X;
        document.getElementById('p2-score').innerText = scores.O;
        document.getElementById('p1-name-display').innerText = limitStr(p1Name);
        document.getElementById('p2-name-display').innerText = p2Name ? limitStr(p2Name) : "Ù…Ù†ØªØ¸Ø±...";
        
        let turnName = (currentPlayer === "X") ? p1Name : (p2Name || "Ø­Ø±ÛŒÙ");
        document.getElementById('game-status').innerText = `Ù†ÙˆØ¨Øª: ${limitStr(turnName)}`;
    }

    async function showLobby() {
        showScreen('lobby-screen');
        const { data } = await supabaseClient.from('rooms').select('*').eq('is_active', true).is('player2_name', null);
        const list = document.getElementById('room-list');
        list.innerHTML = (data && data.length) ? "" : "<p style='color:#94a3b8'>Ø§ØªØ§Ù‚ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯...</p>";
        if(data) data.forEach(r => {
            list.innerHTML += `<div class="room-item">
                <span>Ú©Ø¯: <b class="room-code">${r.room_code}</b> <br><small>Ø³Ø§Ø²Ù†Ø¯Ù‡: ${limitStr(r.player1_name)}</small></span>
                <button class="menu-btn" style="width:70px; padding:5px; font-size:0.9rem;" onclick="joinRoom('${r.id}')">ÙˆØ±ÙˆØ¯</button>
            </div>`;
        });
    }

    async function createOnlineRoom() {
        const code = Math.floor(1000 + Math.random() * 9000);
        const { data } = await supabaseClient.from('rooms').insert([{ 
            player1_name: currentUser, room_code: code.toString(),
            board: Array(9).fill(""), turn: "X", scores: {X:0, O:0}, is_active: true
        }]).select();
        if(data) { currentRoomId = data[0].id; mySymbol = "X"; p1Name = currentUser; p2Name = null; setupOnline(); }
    }

    async function joinRoom(id) {
        const { data } = await supabaseClient.from('rooms').update({ player2_name: currentUser }).eq('id', id).select();
        if(data) { currentRoomId = id; mySymbol = "O"; p1Name = data[0].player1_name; p2Name = currentUser; setupOnline(); }
    }

    function setupOnline() {
        gameMode = "online"; showScreen('game-screen'); renderBoard();
        supabaseClient.channel(`room:${currentRoomId}`)
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'rooms', filter: `id=eq.${currentRoomId}` }, payload => {
                const d = payload.new;
                board = d.board; currentPlayer = d.turn; scores = d.scores; rounds = d.rounds_played + 1;
                p1Name = d.player1_name; p2Name = d.player2_name;
                if(!d.is_active) { 
                    if(rounds <= 5 && scores.X < 5 && scores.O < 5) showFinalResult(true);
                    else { alert("Ø§ØªØ§Ù‚ Ø¨Ø³ØªÙ‡ Ø´Ø¯."); showScreen('menu-screen'); }
                    return; 
                }
                renderBoard();
                if(rounds > 5 || scores.X >= 5 || scores.O >= 5) { showFinalResult(); return; }
                if(currentPlayer === mySymbol && !checkWinner(board) && p2Name) startTimer(); else clearInterval(moveTimer);
            }).subscribe();
    }

    async function syncMove() {
        await supabaseClient.from('rooms').update({ board, turn: currentPlayer, scores, rounds_played: rounds-1 }).eq('id', currentRoomId);
    }

    function startOffline() { gameMode = "offline"; p1Name = "Ø¨Ø§Ø²ÛŒÚ©Ù† 1"; p2Name = "Ø¨Ø§Ø²ÛŒÚ©Ù† 2"; resetScores(); showScreen('game-screen'); }
    function showAiLevels() { showScreen('ai-screen'); }
    function startAi(lvl) { aiLevel = lvl; gameMode = "ai"; p1Name = currentUser; p2Name = "Ø±Ø¨Ø§Øª"; resetScores(); showScreen('game-screen'); }
    function resetGame() { board = Array(9).fill(""); currentPlayer = "X"; renderBoard(); if(gameMode !== "" && (gameMode !== 'online' || p2Name)) startTimer(); }
    function resetScores() { scores = {X:0, O:0}; rounds = 1; document.getElementById('round-info').innerText = "Ø±Ø§Ù†Ø¯: 1 / 5"; resetGame(); }
</script>
</body>
</html>
