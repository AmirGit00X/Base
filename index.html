<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯ÙˆØ² Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ†</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #6366f1; --secondary: #ec4899; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; }
        * { box-sizing: border-box; transition: all 0.2s ease; font-family: 'Segoe UI', Tahoma, sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden; }
        .container { width: 95%; max-width: 450px; background: var(--card); padding: 25px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 1px solid #334155; text-align: center; position: relative; }
        .hidden { display: none !important; }
        
        input { width: 100%; padding: 15px; margin: 15px 0; border-radius: 12px; border: 2px solid #334155; background: #0f172a; color: white; font-size: 1rem; text-align: center; }
        .menu-btn { width: 100%; padding: 16px; margin: 8px 0; border: none; border-radius: 14px; background: var(--primary); color: white; font-size: 1.1rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .menu-btn:hover { filter: brightness(1.2); transform: translateY(-2px); }
        
        .board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 20px 0; }
        .cell { aspect-ratio: 1; background: #334155; border-radius: 16px; display: flex; justify-content: center; align-items: center; font-size: 3rem; font-weight: 800; cursor: pointer; height: 100px; }
        .cell.x { color: #60a5fa; text-shadow: 0 0 15px #60a5fa; }
        .cell.o { color: #f472b6; text-shadow: 0 0 15px #f472b6; }

        .status-bar { display: flex; justify-content: space-between; align-items: center; background: #0f172a; padding: 12px; border-radius: 15px; margin-bottom: 15px; border: 1px solid #334155; }
        #game-status { flex-grow: 1; text-align: center; font-weight: bold; color: var(--primary); font-size: 0.8rem; }
        
        .room-item { background: #0f172a; padding: 12px; margin: 8px 0; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #475569; text-align: right; }
        #result-overlay { position: absolute; inset: 0; background: rgba(15, 23, 42, 0.98); border-radius: 24px; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; border: 2px solid var(--primary); padding: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div id="login-screen">
        <h2>ğŸ® Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯</h2>
        <input type="text" id="username-input" placeholder="Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯...">
        <button class="menu-btn" onclick="login()">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¨Ø§Ø²ÛŒ</button>
    </div>

    <div id="menu-screen" class="hidden">
        <h3 id="welcome-msg"></h3>
        <button class="menu-btn" onclick="openLobby()" style="background: #6366f1;">ğŸŒ Ø¨Ø§Ø²ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ†</button>
        <button class="menu-btn" onclick="startOffline()" style="background: #10b981;">ğŸ‘¥ Ø¨Ø§Ø²ÛŒ Ø¢ÙÙ„Ø§ÛŒÙ†</button>
        <button class="menu-btn" onclick="showAiLevels()" style="background: #f59e0b;">ğŸ¤– Ø¨Ø§Ø²ÛŒ Ø¨Ø§ Ø±Ø¨Ø§Øª</button>
    </div>

    <div id="lobby-screen" class="hidden">
        <h3>Ø§ØªØ§Ù‚â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„</h3>
        <div id="room-list" style="max-height: 250px; overflow-y: auto;"></div>
        <button class="menu-btn" onclick="createOnlineRoom()" style="margin-top:15px;">â• Ø³Ø§Ø®Øª Ø§ØªØ§Ù‚ Ø¬Ø¯ÛŒØ¯</button>
        <button class="menu-btn" onclick="showScreen('menu-screen')" style="background:#475569">Ø¨Ø±Ú¯Ø´Øª</button>
    </div>

    <div id="game-screen" class="hidden">
        <div style="font-size: 0.9rem; margin-bottom: 10px; color: #fbbf24;">â³ Ø²Ù…Ø§Ù† Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: <span id="sec">30</span> Ø«Ø§Ù†ÛŒÙ‡</div>
        <div class="status-bar">
            <div style="width: 80px;"><small id="p1-name-display"></small><br><span id="p1-score" style="font-size:1.4rem">0</span></div>
            <div id="game-status">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø­Ø±ÛŒÙ...</div>
            <div style="width: 80px;"><small id="p2-name-display"></small><br><span id="p2-score" style="font-size:1.4rem">0</span></div>
        </div>
        <div class="board" id="board">
            <div class="cell" onclick="handleMove(0)"></div><div class="cell" onclick="handleMove(1)"></div><div class="cell" onclick="handleMove(2)"></div>
            <div class="cell" onclick="handleMove(3)"></div><div class="cell" onclick="handleMove(4)"></div><div class="cell" onclick="handleMove(5)"></div>
            <div class="cell" onclick="handleMove(6)"></div><div class="cell" onclick="handleMove(7)"></div><div class="cell" onclick="handleMove(8)"></div>
        </div>
        <div id="round-info" style="margin-top:10px; font-weight:bold;">Ø±Ø§Ù†Ø¯: 1 / 5</div>
        
        <button class="menu-btn" onclick="exitCurrentGame()" style="background:#ef4444; margin-top: 15px; font-size: 0.9rem; padding: 12px;">ğŸšª Ø®Ø±ÙˆØ¬ Ø§Ø² Ø§ÛŒÙ† Ø§ØªØ§Ù‚</button>
    </div>

    <div id="result-screen" class="hidden">
        <div id="result-overlay">
            <h2 id="winner-text" style="color: var(--secondary);"></h2>
            <div id="final-scores" style="font-size: 1.2rem; margin-bottom: 20px;"></div>
            <button class="menu-btn" onclick="location.reload()">Ø®Ø±ÙˆØ¬ Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ</button>
        </div>
    </div>
</div>

<script>
    const SB_URL = 'https://kbtvvcbgnvohlxncfjdu.supabase.co';
    const SB_KEY = 'sb_publishable_1S4Ogjebi8k6P7VJZ3te4g_cmub4ub9';
    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

    let currentUser = "", gameMode = "", board = Array(9).fill(""), currentPlayer = "X";
    let scores = { X: 0, O: 0 }, rounds = 1, currentRoomId = null, mySymbol = "X", moveTimer = null;
    let p1Name = "", p2Name = "", lobbyInterval = null;

    function login() {
        const val = document.getElementById('username-input').value.trim();
        if(!val) return alert("Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
        currentUser = val;
        showScreen('menu-screen');
        document.getElementById('welcome-msg').innerText = `Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØŒ ${currentUser}`;
    }

    function showScreen(id) {
        document.querySelectorAll('.container > div').forEach(d => d.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        if(id !== 'lobby-screen') clearInterval(lobbyInterval);
    }

    // ØªØ§Ø¨Ø¹ Ø®Ø±ÙˆØ¬ Ø³Ø±Ø§Ø³Ø±ÛŒ
    async function exitCurrentGame() {
        const confirmExit = confirm("Ø¢ÛŒØ§ Ø§Ø² Ø®Ø±ÙˆØ¬ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ Ø¨Ø§Ø²ÛŒ Ù†ÛŒÙ…Ù‡â€ŒØªÙ…Ø§Ù… Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯.");
        if (!confirmExit) return;

        clearInterval(moveTimer);
        
        if (gameMode === "online" && currentRoomId) {
            // Ø¨Ø³ØªÙ† Ø§ØªØ§Ù‚ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¨Ø±Ø§ÛŒ Ø·Ø±Ù Ù…Ù‚Ø§Ø¨Ù„
            await supabaseClient.from('rooms').update({ is_active: false }).eq('id', currentRoomId);
        }

        // Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ
        showScreen('menu-screen');
        // Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† Ù…ØªØºÛŒØ±Ù‡Ø§
        currentRoomId = null;
        gameMode = "";
        scores = { X: 0, O: 0 };
        rounds = 1;
        board = Array(9).fill("");
    }

    function openLobby() {
        showScreen('lobby-screen');
        fetchRooms();
        lobbyInterval = setInterval(fetchRooms, 5000);
    }

    async function fetchRooms() {
        const { data } = await supabaseClient.from('rooms').select('*').eq('is_active', true).is('player2_name', null);
        const list = document.getElementById('room-list');
        list.innerHTML = (data && data.length) ? "" : "<p style='color:#94a3b8; padding:20px;'>Ø§ØªØ§Ù‚ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯. ÛŒÚ©ÛŒ Ø¨Ø³Ø§Ø²!</p>";
        data?.forEach(r => {
            list.innerHTML += `
                <div class="room-item">
                    <span><b>Ú©Ø¯: ${r.room_code}</b><br><small>Ø³Ø§Ø²Ù†Ø¯Ù‡: ${r.player1_name}</small></span>
                    <button class="menu-btn" style="width:70px; padding:8px; font-size:0.8rem; background:#10b981;" onclick="joinRoom('${r.id}')">ÙˆØ±ÙˆØ¯</button>
                </div>`;
        });
    }

    async function createOnlineRoom() {
        const code = Math.floor(1000 + Math.random() * 9000).toString();
        const { data } = await supabaseClient.from('rooms').insert([{ 
            player1_name: currentUser, room_code: code, board: Array(9).fill(""), turn: "X", scores: {X:0, O:0}, is_active: true
        }]).select();
        if(data) { 
            currentRoomId = data[0].id; 
            mySymbol = "X"; 
            p1Name = currentUser;
            setupOnline(); 
        }
    }

    async function joinRoom(id) {
        const { data } = await supabaseClient.from('rooms').update({ player2_name: currentUser }).eq('id', id).select();
        if(data) { 
            currentRoomId = id; 
            mySymbol = "O"; 
            p1Name = data[0].player1_name;
            p2Name = currentUser;
            setupOnline(); 
        }
    }

    function setupOnline() {
        gameMode = "online";
        showScreen('game-screen');
        renderBoard();

        supabaseClient.channel(`room:${currentRoomId}`)
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'rooms', filter: `id=eq.${currentRoomId}` }, payload => {
                const d = payload.new;
                board = d.board; currentPlayer = d.turn; scores = d.scores; rounds = d.rounds_played + 1;
                p1Name = d.player1_name; p2Name = d.player2_name;

                if(!d.is_active) {
                    if(rounds <= 5 && !document.getElementById('result-screen').classList.contains('hidden') === false) {
                        alert("Ø·Ø±Ù Ù…Ù‚Ø§Ø¨Ù„ Ø§Ø² Ø¨Ø§Ø²ÛŒ Ø®Ø§Ø±Ø¬ Ø´Ø¯ ÛŒØ§ Ø§ØªØ§Ù‚ Ø¨Ø³ØªÙ‡ Ø´Ø¯.");
                        showScreen('menu-screen');
                        clearInterval(moveTimer);
                    }
                    return;
                }

                renderBoard();
                if(p2Name) {
                    if(currentPlayer === mySymbol) startTimer();
                    else clearInterval(moveTimer);
                }
                if(rounds > 5) finalizeGame();
            }).subscribe();
    }

    async function handleMove(i) {
        if (board[i] !== "" || (gameMode === "online" && (currentPlayer !== mySymbol || !p2Name))) return;
        
        board[i] = currentPlayer;
        const win = checkWinner(board);
        if (win) {
            scores[win]++;
            rounds++;
            board = Array(9).fill("");
        } else if (!board.includes("")) {
            rounds++;
            board = Array(9).fill("");
        }
        
        currentPlayer = currentPlayer === "X" ? "O" : "X";
        
        if(gameMode === "online") {
            await supabaseClient.from('rooms').update({ board, turn: currentPlayer, scores, rounds_played: rounds-1 }).eq('id', currentRoomId);
        } else {
            renderBoard();
            if(gameMode === "ai" && currentPlayer === "O") setTimeout(makeAiMove, 600);
        }
    }

    function startTimer() {
        clearInterval(moveTimer);
        let s = 30;
        document.getElementById('sec').innerText = s;
        moveTimer = setInterval(async () => {
            s--;
            document.getElementById('sec').innerText = s;
            if(s <= 0) {
                clearInterval(moveTimer);
                const finalWinner = (mySymbol === "X") ? (p2Name || "Ø­Ø±ÛŒÙ") : p1Name;
                finalizeGame(`Ø²Ù…Ø§Ù† Ø´Ù…Ø§ ØªÙ…Ø§Ù… Ø´Ø¯! Ø¨Ø±Ù†Ø¯Ù‡ Ù†Ù‡Ø§ÛŒÛŒ: ${finalWinner}`);
            }
        }, 1000);
    }

    async function finalizeGame(msg = null) {
        clearInterval(moveTimer);
        if(!msg) {
            msg = (scores.X > scores.O) ? `ğŸ† Ø¨Ø±Ù†Ø¯Ù‡ Ù†Ù‡Ø§ÛŒÛŒ: ${p1Name}` : (scores.O > scores.X ? `ğŸ† Ø¨Ø±Ù†Ø¯Ù‡ Ù†Ù‡Ø§ÛŒÛŒ: ${p2Name}` : "ğŸ¤ Ù…Ø³Ø§ÙˆÛŒ Ø´Ø¯!");
        }
        document.getElementById('winner-text').innerText = msg;
        document.getElementById('final-scores').innerText = `${p1Name}: ${scores.X} | ${p2Name}: ${scores.O}`;
        showScreen('result-screen');
        
        if(currentRoomId && gameMode === "online") {
            await supabaseClient.from('rooms').update({ is_active: false }).eq('id', currentRoomId);
        }
    }

    function checkWinner(b) {
        const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
        for(let c of wins) if(b[c[0]] && b[c[0]]===b[c[1]] && b[c[0]]===b[c[2]]) return b[c[0]];
        return null;
    }

    function renderBoard() {
        const cells = document.querySelectorAll('.cell');
        board.forEach((v, i) => { 
            cells[i].innerText = v; 
            cells[i].className = `cell ${v.toLowerCase()}`; 
        });
        document.getElementById('p1-score').innerText = scores.X;
        document.getElementById('p2-score').innerText = scores.O;
        document.getElementById('p1-name-display').innerText = p1Name || "Ø¨Ø§Ø²ÛŒÚ©Ù† Û±";
        document.getElementById('p2-name-display').innerText = p2Name || "Ù…Ù†ØªØ¸Ø±...";
        document.getElementById('round-info').innerText = `Ø±Ø§Ù†Ø¯: ${Math.min(rounds, 5)} / 5`;
        
        let turnName = (currentPlayer === "X") ? p1Name : (p2Name || "Ø­Ø±ÛŒÙ");
        document.getElementById('game-status').innerText = `Ù†ÙˆØ¨Øª: ${turnName}`;
    }

    function startOffline() {
        gameMode = "offline"; p1Name = "Ø´Ù…Ø§ (X)"; p2Name = "Ø­Ø±ÛŒÙ (O)"; 
        scores = {X:0, O:0}; rounds = 1; board = Array(9).fill("");
        showScreen('game-screen'); renderBoard();
    }

    function showAiLevels() {
        gameMode = "ai"; p1Name = currentUser; p2Name = "Ø±Ø¨Ø§Øª";
        scores = {X:0, O:0}; rounds = 1; board = Array(9).fill("");
        showScreen('game-screen'); renderBoard();
    }

    function makeAiMove() {
        let empty = board.map((v,i)=>v===""?i:null).filter(v=>v!==null);
        if(empty.length && rounds <= 5) handleMove(empty[Math.floor(Math.random()*empty.length)]);
    }
</script>
</body>
</html>
