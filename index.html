<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>دوز حرفه‌ای آنلاین - نسخه امنیتی</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    
    <style>
        :root { --bg-color: #0f172a; --card-bg: #1e293b; --text-main: #f8fafc; --accent-x: #3b82f6; --accent-o: #f43f5e; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: Tahoma, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden; }
        
        #loading-screen { position: fixed; inset: 0; background: var(--bg-color); display: flex; justify-content: center; align-items: center; z-index: 999; }
        .screen { display: none; width: 100vw; height: 100vh; max-width: 450px; flex-direction: column; padding: 20px; align-items: center; justify-content: center; overflow-y: auto; }
        .active-screen { display: flex; }
        
        h1 { font-size: 1.5rem; color: var(--accent-x); margin-bottom: 15px; }
        .menu-group { width: 100%; display: flex; flex-direction: column; gap: 10px; }
        .menu-btn { width: 100%; padding: 12px; background: var(--card-bg); color: white; border: 2px solid #334155; border-radius: 12px; font-size: 0.95rem; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .menu-btn:active { transform: scale(0.95); opacity: 0.8; }
        
        input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #334155; background: #0f172a; color: white; text-align: center; margin-bottom: 10px; }
        .room-list { width: 100%; flex-grow: 1; overflow-y: auto; background: rgba(255,255,255,0.05); border-radius: 15px; padding: 10px; margin-top: 10px; border: 1px solid #334155; }
        .room-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--card-bg); margin-bottom: 10px; border-radius: 15px; border: 1px solid #334155; }
        
        /* دکمه ورود زیبا */
        .join-btn { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border: none; padding: 8px 18px; border-radius: 10px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3); }

        .stats-box { background: var(--card-bg); width: 100%; padding: 15px; border-radius: 15px; margin-bottom: 15px; font-size: 0.85rem; line-height: 1.8; border: 1px solid var(--accent-x); }
        .scoreboard { display: flex; gap: 15px; margin-bottom: 15px; }
        .score-item { background: var(--card-bg); padding: 10px 20px; border-radius: 12px; text-align: center; min-width: 100px; }
        .board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; background: rgba(255, 255, 255, 0.05); padding: 10px; border-radius: 20px; }
        .cell { width: 85px; height: 85px; background: var(--card-bg); border-radius: 15px; display: flex; justify-content: center; align-items: center; font-size: 2rem; font-weight: bold; cursor: pointer; border: 1px solid #334155; }
        .cell.x { color: var(--accent-x); } .cell.o { color: var(--accent-o); }
        .overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.98); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 100; padding: 20px; }
        .level-select { display: flex; gap: 5px; margin-bottom: 10px; width: 100%; }
        .lvl-btn { flex: 1; padding: 8px; font-size: 0.8rem; border-radius: 8px; border: 1px solid #334155; background: var(--card-bg); color: white; cursor: pointer; }
        .lvl-btn.active { background: var(--accent-x); }
    </style>
</head>
<body>

    <div id="loading-screen">در حال اتصال به سرور...</div>

    <div id="auth-screen" class="screen">
        <h1>ورود / عضویت</h1>
        <input type="text" id="auth-user" placeholder="نام کاربری (حداقل ۳ حرف انگلیسی)">
        <input type="password" id="auth-pass" placeholder="رمز عبور (حداقل ۴ کاراکتر)">
        <input type="text" id="auth-nick" placeholder="نام مستعار (نمایشی)">
        <div class="menu-group">
            <button class="menu-btn" style="background: var(--accent-x);" onclick="handleAuth('login')">ورود به اکانت</button>
            <button class="menu-btn" onclick="handleAuth('register')">ساخت اکانت جدید</button>
        </div>
    </div>

    <div id="main-menu" class="screen">
        <h1 id="welcome-text">دوز آنلاین</h1>
        <div class="stats-box" id="user-stats">در حال بارگذاری آمار...</div>
        <div class="menu-group">
            <button class="menu-btn" onclick="showScreen('lobby-screen')">بازی آنلاین</button>
            <button class="menu-btn" onclick="showLocalConfig('pvp')">دو نفره آفلاین</button>
            <button class="menu-btn" onclick="showLocalConfig('pvc')">بازی با ربات</button>
            <hr style="opacity: 0.1; margin: 5px 0;">
            <button class="menu-btn" style="color: #94a3b8;" onclick="changeNickname()">تغییر نام مستعار</button>
            <button class="menu-btn" style="color: #f43f5e;" onclick="deleteAccount()">حذف کامل اکانت</button>
            <button class="menu-btn" onclick="logout()">خروج از حساب</button>
        </div>
    </div>

    <div id="lobby-screen" class="screen" style="justify-content: flex-start; padding-top: 40px;">
        <h1>لیست اتاق‌ها</h1>
        <div class="menu-group">
            <button class="menu-btn" style="background: #10b981;" onclick="createRoom()">+ ساخت اتاق جدید</button>
            <button class="menu-btn" onclick="showScreen('main-menu')">برگشت به منو</button>
        </div>
        <div class="room-list" id="room-container"></div>
    </div>

    <div id="game-screen" class="screen">
        <div id="bot-config" style="display:none; width: 100%; margin-bottom: 10px;">
            <div class="level-select">
                <button class="lvl-btn active" onclick="setDifficulty('easy', this)">آسان</button>
                <button class="lvl-btn" onclick="setDifficulty('med', this)">متوسط</button>
                <button class="lvl-btn" onclick="setDifficulty('hard', this)">سخت</button>
            </div>
        </div>
        
        <div class="scoreboard">
            <div class="score-item">
                <div id="label-x" style="font-size: 0.7rem;">X</div>
                <div class="score-val" id="score-x">0</div>
            </div>
            <div class="score-item">
                <div id="label-o" style="font-size: 0.7rem;">O</div>
                <div class="score-val" id="score-o">0</div>
            </div>
        </div>

        <div class="status-text" id="status">...</div>
        
        <div class="board" id="board-container">
            <div class="cell" onclick="handleCellClick(0)"></div>
            <div class="cell" onclick="handleCellClick(1)"></div>
            <div class="cell" onclick="handleCellClick(2)"></div>
            <div class="cell" onclick="handleCellClick(3)"></div>
            <div class="cell" onclick="handleCellClick(4)"></div>
            <div class="cell" onclick="handleCellClick(5)"></div>
            <div class="cell" onclick="handleCellClick(6)"></div>
            <div class="cell" onclick="handleCellClick(7)"></div>
            <div class="cell" onclick="handleCellClick(8)"></div>
        </div>

        <div class="menu-group" style="margin-top: 15px;">
            <button id="reset-local-btn" class="menu-btn" style="display:none; background: #64748b;" onclick="resetLocalScores()">صفر کردن امتیاز</button>
            <button class="menu-btn" style="background: #475569;" onclick="exitGame()">خروج از بازی</button>
        </div>
    </div>

    <div class="overlay" id="overlay">
        <h1 id="winner-text"></h1>
        <p id="winner-subtext" style="margin-bottom: 20px; color: #94a3b8;"></p>
        <button id="rematch-btn" class="menu-btn" style="width: 200px; background: var(--accent-x);" onclick="resetMatch()">بازی دوباره</button>
        <button class="menu-btn" style="width: 200px; margin-top:10px;" onclick="exitGame()">خروج</button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDTZ68yTUyrpoKJdVRQzY7ZJ2mUUrWv-PM",
            authDomain: "my-online-game-91998.firebaseapp.com",
            databaseURL: "https://my-online-game-91998-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "my-online-game-91998",
            storageBucket: "my-online-game-91998.firebasestorage.app",
            messagingSenderId: "656716202334",
            appId: "1:656716202334:web:1ded52f8ac914b2b61cfcf"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentUser = JSON.parse(localStorage.getItem('tt_user_data')) || null;
        let mySessionId = Math.random().toString(36).substring(7);
        let currentRoomId = null;
        let mySymbol = "X"; 
        let isOnline = false;
        let gameMode = "pvp";
        let difficulty = "easy";
        let board = Array(9).fill("");
        let turn = "X";
        let localScores = {X: 0, O: 0};
        let gameActive = true;

        window.addEventListener('load', () => {
            document.getElementById('loading-screen').style.display = 'none';
            if (currentUser) loginSuccess(); else showScreen('auth-screen');
        });

        // --- سیستم احراز هویت و Session ---
        function handleAuth(type) {
            const user = document.getElementById('auth-user').value.trim().toLowerCase();
            const pass = document.getElementById('auth-pass').value.trim();
            const nick = document.getElementById('auth-nick').value.trim();

            // اعتبارسنجی
            const userRegex = /^[a-zA-Z0-9]{3,}$/;
            if (!userRegex.test(user)) return alert("نام کاربری باید حداقل ۳ کاراکتر و فقط حروف/اعداد انگلیسی باشد.");
            if (pass.length < 4) return alert("رمز عبور باید حداقل ۴ کاراکتر باشد.");

            db.ref('users/' + user).once('value', snap => {
                const data = snap.val();
                if (type === 'register') {
                    if (data) return alert("این نام کاربری قبلا گرفته شده");
                    const newUser = { username: user, password: pass, nickname: nick || user, wins:0, losses:0, draws:0, sessionId: mySessionId };
                    db.ref('users/' + user).set(newUser).then(() => {
                        currentUser = newUser; loginSuccess();
                    });
                } else {
                    if (data && data.password === pass) {
                        currentUser = data;
                        db.ref('users/' + user).update({ sessionId: mySessionId });
                        loginSuccess();
                    } else alert("نام کاربری یا رمز اشتباه");
                }
            });
        }

        function loginSuccess() {
            localStorage.setItem('tt_user_data', JSON.stringify(currentUser));
            document.getElementById('welcome-text').innerText = "خوش آمدی " + currentUser.nickname;
            
            // گوش دادن به Session (جلوگیری از ورود همزمان)
            db.ref('users/' + currentUser.username + '/sessionId').on('value', snap => {
                if (snap.val() && snap.val() !== mySessionId) {
                    alert("اکانت شما در دستگاه دیگری باز شد.");
                    logout();
                }
            });

            updateStatsUI();
            showScreen('main-menu');
            listenToRooms();
        }

        function updateStatsUI() {
            db.ref('users/' + currentUser.username).on('value', snap => {
                const d = snap.val();
                if (!d) return;
                const total = d.wins + d.losses + d.draws;
                const rate = total === 0 ? 0 : ((d.wins / total) * 100).toFixed(1);
                document.getElementById('user-stats').innerHTML = `
                    <b>نام مستعار:</b> ${d.nickname} <br>
                    <b>برد:</b> ${d.wins} | <b>باخت:</b> ${d.losses} | <b>مساوی:</b> ${d.draws} <br>
                    <b>کل بازی‌ها:</b> ${total} | <b>درصد پیروزی:</b> ${rate}%
                `;
            });
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.getElementById(id).classList.add('active-screen');
        }

        function logout() {
            localStorage.removeItem('tt_user_data');
            location.reload();
        }

        function changeNickname() {
            const n = prompt("نام مستعار جدید را وارد کنید:");
            if (n) db.ref('users/' + currentUser.username).update({ nickname: n });
        }

        function deleteAccount() {
            if (confirm("آیا از حذف اکانت و تمام سوابق اطمینان دارید؟")) {
                db.ref('users/' + currentUser.username).remove().then(logout);
            }
        }

        // --- بخش آنلاین ---
        function listenToRooms() {
            db.ref('rooms').on('value', snapshot => {
                const rooms = snapshot.val();
                const container = document.getElementById('room-container');
                container.innerHTML = "";
                if (!rooms) return;
                Object.keys(rooms).forEach(id => {
                    if (rooms[id].status === "waiting") {
                        const div = document.createElement('div');
                        div.className = 'room-item';
                        div.innerHTML = `<span>اتاق ${id} (${rooms[id].creator})</span> 
                                         <button class="join-btn" onclick="joinRoom('${id}')">ورود</button>`;
                        container.appendChild(div);
                    }
                });
            });
        }

        function createRoom() {
            const id = Math.floor(100000 + Math.random() * 900000).toString();
            currentRoomId = id; mySymbol = "X"; isOnline = true; gameActive = true;
            const roomData = {
                creator: currentUser.nickname, 
                playerX: currentUser.username, playerXNick: currentUser.nickname,
                playerO: "", playerONick: "",
                status: "waiting", board: Array(9).fill(""), turn: "X",
                scores: {X: 0, O: 0}
            };
            db.ref('rooms/' + id).set(roomData);
            
            // اگر سازنده قطع شد، اتاق حذف شود و برای او باخت ثبت شود (اگر بازی شروع شده بود)
            db.ref('rooms/' + id).onDisconnect().remove();
            setupOnlineListener(id);
            showScreen('game-screen');
            document.getElementById('bot-config').style.display = 'none';
            document.getElementById('reset-local-btn').style.display = 'none';
        }

        function joinRoom(id) {
            currentRoomId = id; mySymbol = "O"; isOnline = true; gameActive = true;
            db.ref('rooms/' + id).update({ 
                playerO: currentUser.username, 
                playerONick: currentUser.nickname,
                status: "playing" 
            });

            // ثبت شکست در صورت قطع اتصال وسط بازی
            const userRef = db.ref('users/' + currentUser.username + '/losses');
            userRef.once('value', s => {
                db.ref('rooms/' + id).onDisconnect().update({ playerO: "OFFLINE" });
                // این منطق پیچیده فایربیس برای ثبت باخت هنگام آفلاین شدن است:
                db.ref('users/' + currentUser.username + '/losses').onDisconnect().set(s.val() + 1);
            });

            setupOnlineListener(id);
            showScreen('game-screen');
        }

        function setupOnlineListener(id) {
            db.ref('rooms/' + id).on('value', snapshot => {
                const data = snapshot.val();
                if (!data) {
                    if (gameActive) alert("اتاق بسته شد.");
                    exitGame(); return;
                }
                
                if (data.status === "playing") {
                    if ((mySymbol === "X" && data.playerO === "OFFLINE") || (mySymbol === "O" && data.playerX === "OFFLINE")) {
                        showWinnerOverlay("حریف آفلاین شد! برد برای شما.");
                        if (gameActive) syncOnlineResult('win');
                        gameActive = false;
                        db.ref('users/' + currentUser.username + '/losses').onDisconnect().cancel(); // لغو جریمه چون حریف رفته
                    }
                }

                board = data.board || Array(9).fill("");
                turn = data.turn;
                renderBoard();
                document.getElementById('label-x').innerText = data.playerXNick;
                document.getElementById('label-o').innerText = data.playerONick || "در انتظار...";
                document.getElementById('score-x').innerText = data.scores.X;
                document.getElementById('score-o').innerText = data.scores.O;
                document.getElementById('status').innerText = (data.status === "waiting") ? "کد: " + id : (turn === mySymbol ? "نوبت شما" : "نوبت حریف");
                checkWinnerLogic(data.scores);
            });
        }

        // --- بخش آفلاین و ربات (بدون تغییر) ---
        function showLocalConfig(mode) {
            isOnline = false; gameMode = mode; gameActive = true;
            board = Array(9).fill(""); turn = "X";
            localScores = {X: 0, O: 0};
            document.getElementById('score-x').innerText = "0";
            document.getElementById('score-o').innerText = "0";
            document.getElementById('label-x').innerText = currentUser.nickname;
            document.getElementById('label-o').innerText = (mode === 'pvc') ? "ربات" : "بازیکن ۲";
            document.getElementById('bot-config').style.display = (mode === 'pvc') ? 'block' : 'none';
            document.getElementById('reset-local-btn').style.display = 'block';
            document.getElementById('status').innerText = "نوبت X";
            renderBoard();
            showScreen('game-screen');
        }

        function setDifficulty(lvl, btn) {
            difficulty = lvl;
            document.querySelectorAll('.lvl-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function resetLocalScores() {
            localScores = {X: 0, O: 0};
            document.getElementById('score-x').innerText = "0";
            document.getElementById('score-o').innerText = "0";
            resetMatch();
        }

        function handleCellClick(i) {
            if (!gameActive || board[i] !== "") return;
            if (isOnline) {
                if (turn !== mySymbol) return;
                board[i] = mySymbol;
                db.ref('rooms/' + currentRoomId).update({ board: board, turn: (mySymbol === "X" ? "O" : "X") });
            } else {
                board[i] = turn;
                renderBoard();
                if(!checkWinnerLogic()) {
                    turn = (turn === "X" ? "O" : "X");
                    document.getElementById('status').innerText = "نوبت " + turn;
                    if (gameMode === "pvc" && turn === "O") setTimeout(botPlay, 500);
                }
            }
        }

        function botPlay() {
            let move;
            if (difficulty === "easy") {
                const empty = board.map((v, i) => v === "" ? i : null).filter(v => v !== null);
                move = empty[Math.floor(Math.random() * empty.length)];
            } else if (difficulty === "med") {
                move = Math.random() > 0.5 ? minimax(board, "O").index : board.indexOf("");
            } else {
                move = minimax(board, "O").index;
            }
    
