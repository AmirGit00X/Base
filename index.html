<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>پیام‌رسان زنده و ریسپانسیو</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            --glass: rgba(255, 255, 255, 0.1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100%;
            font-family: 'Tahoma', sans-serif;
            background: var(--bg-gradient); background-attachment: fixed;
            overflow: hidden;
        }

        /* صفحه ورود */
        #login-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85);
            display: flex; justify-content: center; align-items: center; z-index: 9999;
            backdrop-filter: blur(10px);
        }
        .login-box {
            background: white; padding: 30px; border-radius: 20px;
            width: 85%; max-width: 350px; text-align: center;
        }
        .login-box input {
            width: 100%; padding: 12px; margin: 15px 0; border: 1px solid #ddd; border-radius: 10px; outline: none;
        }
        .login-box button {
            width: 100%; background: #2196F3; color: white; border: none; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer;
        }

        /* ساختار چت (موبایل اول) */
        .app-container {
            display: flex; flex-direction: column; height: 100%; width: 100%;
            background: rgba(0,0,0,0.3);
        }

        header {
            padding: 15px; background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
            color: white; text-align: center; font-size: 1.1rem; font-weight: bold;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        #chat-window {
            flex: 1; overflow-y: auto; padding: 15px;
            display: flex; flex-direction: column; gap: 10px;
            scroll-behavior: smooth;
        }

        /* حباب پیام‌ها */
        .msg {
            max-width: 80%; padding: 10px 14px; border-radius: 18px;
            color: white; position: relative; word-wrap: break-word;
            font-size: 14px; line-height: 1.5;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .my-msg { align-self: flex-start; background: #0084ff; border-bottom-left-radius: 2px; }
        .other-msg { align-self: flex-end; background: rgba(255,255,255,0.2); border-bottom-right-radius: 2px; }

        .sender-name { font-size: 10px; font-weight: bold; display: block; margin-bottom: 4px; opacity: 0.8; }
        .delete-btn { font-size: 10px; margin-top: 5px; cursor: pointer; display: inline-block; opacity: 0.5; }

        /* ورودی پیام */
        .input-bar {
            padding: 10px 15px; background: rgba(255,255,255,0.1);
            display: flex; align-items: center; gap: 10px; backdrop-filter: blur(10px);
        }
        .input-bar input[type="text"] {
            flex: 1; background: rgba(255,255,255,0.2); border: none;
            padding: 12px; border-radius: 25px; color: white; outline: none;
        }
        .input-bar label { color: white; font-size: 1.4rem; cursor: pointer; }
        #send-btn {
            background: #4CAF50; border: none; color: white; width: 45px; height: 45px;
            border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        /* رسانه */
        img, video { max-width: 100%; border-radius: 10px; display: block; margin: 5px 0; }
        audio { width: 100%; margin-top: 5px; }

        @media (min-width: 768px) {
            .app-container { width: 450px; margin: auto; height: 90vh; border-radius: 25px; border: 1px solid rgba(255,255,255,0.2); }
        }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h3>نام کاربری</h3>
            <input type="text" id="username" placeholder="نام شما...">
            <button id="start-btn">ورود به چت</button>
        </div>
    </div>

    <div class="app-container">
        <header>گروه چت آنلاین</header>
        <div id="chat-window"></div>
        <div class="input-bar">
            <label><input type="file" id="media-file" hidden><i class="fas fa-plus-circle"></i></label>
            <input type="text" id="msg-input" placeholder="پیام...">
            <button id="send-btn"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDTZ68yTUyrpoKJdVRQzY7ZJ2mUUrWv-PM",
            authDomain: "my-online-game-91998.firebaseapp.com",
            projectId: "my-online-game-91998",
            storageBucket: "my-online-game-91998.firebasestorage.app",
            messagingSenderId: "656716202334",
            appId: "1:656716202334:web:1ded52f8ac914b2b61cfcf"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let user = localStorage.getItem("chat_user") || "";
        if(user) document.getElementById('login-overlay').style.display = 'none';

        document.getElementById('start-btn').onclick = () => {
            const val = document.getElementById('username').value.trim();
            if(val) { user = val; localStorage.setItem("chat_user", val); document.getElementById('login-overlay').style.display = 'none'; }
        };

        // ارسال پیام متنی
        async function postMessage(data) {
            await addDoc(collection(db, "chats"), { ...data, sender: user, time: serverTimestamp() });
        }

        document.getElementById('send-btn').onclick = () => {
            const input = document.getElementById('msg-input');
            if(input.value.trim()) { postMessage({ type: 'text', content: input.value }); input.value = ""; }
        };

        // ارسال فایل (مدیا)
        document.getElementById('media-file').onchange = async (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const fileRef = ref(storage, `chat/${Date.now()}_${file.name}`);
            await uploadBytes(fileRef, file);
            const url = await getDownloadURL(fileRef);
            
            let mime = 'file';
            if(file.type.startsWith('image')) mime = 'image';
            else if(file.type.startsWith('video')) mime = 'video';
            else if(file.type.startsWith('audio')) mime = 'audio';

            postMessage({ type: mime, content: url, fileName: file.name });
        };

        // گوش دادن به تغییرات سرور (Live Sync)
        const q = query(collection(db, "chats"), orderBy("time", "asc"));
        onSnapshot(q, (snap) => {
            const win = document.getElementById('chat-window');
            win.innerHTML = "";
            snap.forEach(d => {
                const m = d.data();
                const isMe = m.sender === user;
                const div = document.createElement('div');
                div.className = `msg ${isMe ? 'my-msg' : 'other-msg'}`;
                
                let html = `<span class="sender-name">${m.sender}</span>`;
                if(m.type === 'text') html += m.content;
                else if(m.type === 'image') html += `<img src="${m.content}">`;
                else if(m.type === 'video') html += `<video src="${m.content}" controls></video>`;
                else if(m.type === 'audio') html += `<audio src="${m.content}" controls></audio>`;
                else html += `<a href="${m.content}" target="_blank" style="color:white">فایل: ${m.fileName}</a>`;

                if(isMe) html += `<br><span class="delete-btn" onclick="window.delMsg('${d.id}')">حذف</span>`;
                
                div.innerHTML = html;
                win.appendChild(div);
            });
            win.scrollTop = win.scrollHeight; // همیشه آخرین پیام معلوم باشد
        });

        window.delMsg = async (id) => { if(confirm("حذف پیام؟")) await deleteDoc(doc(db, "chats", id)); };
    </script>
</body>
</html>
