<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯ÙˆØ² Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ†</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #6366f1; --secondary: #ec4899; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; }
        * { box-sizing: border-box; transition: all 0.2s ease; font-family: 'Segoe UI', Tahoma, sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden; }
        
        .container { width: 95%; max-width: 450px; background: var(--card); padding: 25px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 1px solid #334155; text-align: center; position: relative; min-height: 500px; display: flex; flex-direction: column; justify-content: center; }
        .hidden { display: none !important; }

        /* Loading Spinner */
        .loader-container { position: absolute; inset: 0; background: var(--card); border-radius: 24px; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; }
        .spinner { width: 50px; height: 50px; border: 5px solid #334155; border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        input { width: 100%; padding: 15px; margin: 15px 0; border-radius: 12px; border: 2px solid #334155; background: #0f172a; color: white; font-size: 1rem; text-align: center; }
        .menu-btn { width: 100%; padding: 16px; margin: 8px 0; border: none; border-radius: 14px; background: var(--primary); color: white; font-size: 1.1rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3); }
        .menu-btn:hover { filter: brightness(1.1); transform: translateY(-2px); }
        
        /* Room Items UI */
        .room-item { background: #1e293b; padding: 15px; margin: 10px 0; border-radius: 16px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #334155; background: linear-gradient(145deg, #1e293b, #161e2d); }
        .room-info-text { text-align: right; }
        .room-code-badge { background: var(--primary); color: white; padding: 2px 8px; border-radius: 6px; font-size: 0.8rem; margin-bottom: 4px; display: inline-block; }

        .board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 15px 0; }
        .cell { aspect-ratio: 1; background: #334155; border-radius: 16px; display: flex; justify-content: center; align-items: center; font-size: 2.8rem; font-weight: 800; cursor: pointer; height: 95px; }
        .cell.x { color: #60a5fa; text-shadow: 0 0 15px #60a5fa; }
        .cell.o { color: #f472b6; text-shadow: 0 0 15px #f472b6; }

        .status-bar { display: flex; justify-content: space-between; align-items: center; background: #0f172a; padding: 12px; border-radius: 18px; margin-bottom: 10px; border: 1px solid #334155; }
        #result-overlay { position: absolute; inset: 0; background: rgba(15, 23, 42, 0.98); border-radius: 24px; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; padding: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div id="loading-screen" class="loader-container hidden">
        <div class="spinner"></div>
        <p style="margin-top: 15px; color: var(--primary);">Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...</p>
    </div>

    <div id="login-screen">
        <h2 style="font-size: 2rem; margin-bottom: 5px;">ğŸ® ØªÛŒÚ©â€ŒØªØ§Ú©â€ŒØªÙˆ</h2>
        <p style="color: #94a3b8; margin-bottom: 20px;">Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</p>
        <input type="text" id="username-input" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø¹Ù„ÛŒ">
        <button class="menu-btn" onclick="login()">Ø¨Ø²Ù† Ø¨Ø±ÛŒÙ…</button>
    </div>

    <div id="menu-screen" class="hidden">
        <h3 id="welcome-msg" style="color: var(--secondary);"></h3>
        <button class="menu-btn" onclick="openLobby()" style="background: #6366f1;">ğŸŒ Ù†Ø¨Ø±Ø¯ Ø¢Ù†Ù„Ø§ÛŒÙ†</button>
        <button class="menu-btn" onclick="startOffline()" style="background: #10b981;">ğŸ‘¥ Ø¯ÙˆÙ†ÙØ±Ù‡ (Ø¢ÙÙ„Ø§ÛŒÙ†)</button>
        <button class="menu-btn" onclick="showAiLevels()" style="background: #f59e0b;">ğŸ¤– Ø¨Ø§Ø²ÛŒ Ø¨Ø§ Ø±Ø¨Ø§Øª</button>
        <button onclick="clearUser()" style="background:none; border:none; color:#64748b; margin-top:15px; cursor:pointer;">ğŸ”„ Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨</button>
    </div>

    <div id="lobby-screen" class="hidden">
        <h3>ğŸ† ØªØ§Ù„Ø§Ø± Ø±Ù‚Ø§Ø¨Øª</h3>
        <div id="room-list" style="max-height: 280px; overflow-y: auto; padding: 5px;"></div>
        <button class="menu-btn" onclick="createOnlineRoom()">â• Ø³Ø§Ø®Øª Ù…ÛŒØ² Ø¬Ø¯ÛŒØ¯</button>
        <button class="menu-btn" onclick="showScreen('menu-screen')" style="background:#475569">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
    </div>

    <div id="game-screen" class="hidden">
        <div style="font-size: 0.85rem; color: #fbbf24; margin-bottom:8px; font-weight: bold;">â³ Ø²Ù…Ø§Ù† Ø­Ø±Ú©Øª: <span id="sec">30</span></div>
        <div class="status-bar">
            <div><small id="p1-name-display"></small><br><b id="p1-score" style="font-size:1.4rem">0</b></div>
            <div id="game-status" style="color:var(--primary); font-size: 0.8rem;">Ù†ÙˆØ¨Øª Ø´Ù…Ø§Ø³Øª</div>
            <div><small id="p2-name-display"></small><br><b id="p2-score" style="font-size:1.4rem">0</b></div>
        </div>
        <div class="board" id="board">
            <div class="cell" onclick="handleMove(0)"></div><div class="cell" onclick="handleMove(1)"></div><div class="cell" onclick="handleMove(2)"></div>
            <div class="cell" onclick="handleMove(3)"></div><div class="cell" onclick="handleMove(4)"></div><div class="cell" onclick="handleMove(5)"></div>
            <div class="cell" onclick="handleMove(6)"></div><div class="cell" onclick="handleMove(7)"></div><div class="cell" onclick="handleMove(8)"></div>
        </div>
        <div id="round-info" style="color: #94a3b8;">Ø±Ø§Ù†Ø¯: 1 / 5</div>
        <button class="menu-btn" onclick="exitCurrentGame()" style="background:#ef4444; margin-top: 15px; font-size: 0.9rem; padding: 12px;">ğŸšª Ø®Ø±ÙˆØ¬ Ø§Ø² Ø§ØªØ§Ù‚</button>
    </div>

    <div id="result-screen" class="hidden">
        <div id="result-overlay">
            <h2 id="winner-text" style="color: var(--secondary); font-size: 1.8rem;"></h2>
            <div id="final-scores" style="font-size: 1.2rem; margin-bottom: 25px; color: #94a3b8;"></div>
            <button class="menu-btn" onclick="showScreen('menu-screen')">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„Ø§Ø¨ÛŒ</button>
        </div>
    </div>
</div>

<script>
    const SB_URL = 'https://kbtvvcbgnvohlxncfjdu.supabase.co';
    const SB_KEY = 'sb_publishable_1S4Ogjebi8k6P7VJZ3te4g_cmub4ub9';
    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

    let currentUser = "", gameMode = "", board = Array(9).fill(""), currentPlayer = "X";
    let scores = { X: 0, O: 0 }, rounds = 1, currentRoomId = null, mySymbol = "X", moveTimer = null;
    let p1Name = "", p2Name = "", lobbyInterval = null, currentSub = null;

    // --- Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø´Ù† Û²Û´ Ø³Ø§Ø¹ØªÙ‡ ---
    window.onload = () => {
        const saved = JSON.parse(localStorage.getItem('tic_session'));
        if (saved && (new Date().getTime() - saved.timestamp < 86400000)) {
            currentUser = saved.name;
            showScreen('menu-screen');
            document.getElementById('welcome-msg').innerText = `Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒØŒ ${currentUser} ğŸ‘‹`;
        }
    };

    function login() {
        const val = document.getElementById('username-input').value.trim();
        if(!val) return alert("Ù†Ø§Ù…Øª Ø±Ùˆ Ø¨Ù†ÙˆÛŒØ³!");
        currentUser = val;
        localStorage.setItem('tic_session', JSON.stringify({ name: val, timestamp: new Date().getTime() }));
        showScreen('menu-screen');
        document.getElementById('welcome-msg').innerText = `Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒØŒ ${currentUser} ğŸ‘‹`;
    }

    function clearUser() { localStorage.removeItem('tic_session'); location.reload(); }

    function showScreen(id) {
        document.querySelectorAll('.container > div:not(.loader-container)').forEach(d => d.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        if (id === 'menu-screen') resetAll();
    }

    function resetAll() {
        clearInterval(moveTimer);
        clearInterval(lobbyInterval);
        if(currentSub) { supabaseClient.removeChannel(currentSub); currentSub = null; }
        currentRoomId = null; board = Array(9).fill(""); scores = {X:0, O:0}; rounds = 1; currentPlayer = "X";
    }

    function toggleLoader(show) {
        document.getElementById('loading-screen').classList.toggle('hidden', !show);
    }

    // --- Ø¢Ù†Ù„Ø§ÛŒÙ† ---
    function openLobby() {
        showScreen('lobby-screen');
        fetchRooms();
        lobbyInterval = setInterval(fetchRooms, 4000);
    }

    async function fetchRooms() {
        const { data } = await supabaseClient.from('rooms').select('*').eq('is_active', true).is('player2_name', null);
        const list = document.getElementById('room-list');
        if (!data || data.length === 0) {
            list.innerHTML = `<p style="color:#64748b; margin:20px;">Ø§ØªØ§Ù‚ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ØŒ Ø®ÙˆØ¯Øª ÛŒÚ©ÛŒ Ø¨Ø³Ø§Ø²!</p>`;
            return;
        }
        list.innerHTML = "";
        data.forEach(r => {
            list.innerHTML += `
            <div class="room-item">
                <div class="room-info-text">
                    <span class="room-code-badge">#${r.room_code}</span><br>
                    <span style="font-size:0.9rem">Ù…ÛŒØ²Ø¨Ø§Ù†: <b>${r.player1_name}</b></span>
                </div>
                <button class="menu-btn" style="width:80px; padding:8px; font-size:0.8rem; background:#10b981;" onclick="joinRoom('${r.id}')">ÙˆØ±ÙˆØ¯</button>
            </div>`;
        });
    }

    async function createOnlineRoom() {
        toggleLoader(true);
        const code = Math.floor(1000 + Math.random() * 9000).toString();
        const { data, error } = await supabaseClient.from('rooms').insert([{ 
            player1_name: currentUser, room_code: code, board: Array(9).fill(""), turn: "X", scores: {X:0, O:0}, is_active: true
        }]).select();
        
        toggleLoader(false);
        if(data) { 
            currentRoomId = data[0].id; mySymbol = "X"; p1Name = currentUser; p2Name = "";
            setupOnline(); 
        }
    }

    async function joinRoom(id) {
        toggleLoader(true);
        const { data } = await supabaseClient.from('rooms').update({ player2_name: currentUser }).eq('id', id).select();
        toggleLoader(false);
        if(data) { 
            currentRoomId = id; mySymbol = "O"; p1Name = data[0].player1_name; p2Name = currentUser;
            setupOnline(); 
        }
    }

    function setupOnline() {
        gameMode = "online";
        showScreen('game-screen');
        renderBoard();

        currentSub = supabaseClient.channel(`room_${currentRoomId}`)
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'rooms', filter: `id=eq.${currentRoomId}` }, payload => {
                const d = payload.new;
                if(!d.is_active) {
                    if(rounds <= 5 && !document.getElementById('result-screen').classList.contains('hidden') === false) {
                        alert("Ø­Ø±ÛŒÙ Ø§Ø² Ø¨Ø§Ø²ÛŒ Ø®Ø§Ø±Ø¬ Ø´Ø¯! Ø´Ù…Ø§ Ø¨Ø±Ù†Ø¯Ù‡ Ø´Ø¯ÛŒØ¯.");
                        showScreen('menu-screen');
                    }
                    return;
                }
                board = d.board; currentPlayer = d.turn; scores = d.scores; rounds = d.rounds_played + 1;
                p1Name = d.player1_name; p2Name = d.player2_name;
                renderBoard();
                if(p2Name) {
                    if(currentPlayer === mySymbol) startTimer(); else clearInterval(moveTimer);
                }
                if(rounds > 5) finalizeGame();
            }).subscribe();
    }

    async function handleMove(i) {
        if (board[i] !== "" || (gameMode === "online" && (currentPlayer !== mySymbol || !p2Name))) return;
        
        board[i] = currentPlayer;
        const win = checkWinner(board);
        if (win) { scores[win]++; rounds++; board = Array(9).fill(""); }
        else if (!board.includes("")) { rounds++; board = Array(9).fill(""); }
        
        currentPlayer = currentPlayer === "X" ? "O" : "X";
        
        if(gameMode === "online") {
            await supabaseClient.from('rooms').update({ board, turn: currentPlayer, scores, rounds_played: rounds-1 }).eq('id', currentRoomId);
        } else {
            renderBoard();
            if(gameMode === "ai" && currentPlayer === "O") setTimeout(makeAiMove, 600);
        }
    }

    function startTimer() {
        clearInterval(moveTimer);
        let s = 30; document.getElementById('sec').innerText = s;
        moveTimer = setInterval(() => {
            s--; document.getElementById('sec').innerText = s;
            if(s <= 0) { clearInterval(moveTimer); finalizeGame(`Ø²Ù…Ø§Ù† ØªÙ…ÙˆÙ… Ø´Ø¯! Ø¨Ø±Ù†Ø¯Ù‡: ${mySymbol==='X'?(p2Name||'Ø­Ø±ÛŒÙ'):p1Name}`); }
        }, 1000);
    }

    async function exitCurrentGame() {
        if (gameMode === "online" && currentRoomId) {
            await supabaseClient.from('rooms').update({ is_active: false }).eq('id', currentRoomId);
        }
        showScreen('menu-screen');
    }

    async function finalizeGame(msg = null) {
        clearInterval(moveTimer);
        if(!msg) msg = (scores.X > scores.O) ? `ğŸ† Ø¨Ø±Ù†Ø¯Ù‡ Ù†Ù‡Ø§ÛŒÛŒ: ${p1Name}` : (scores.O > scores.X ? `ğŸ† Ø¨Ø±Ù†Ø¯Ù‡ Ù†Ù‡Ø§ÛŒÛŒ: ${p2Name}` : "ğŸ¤ Ù…Ø³Ø§ÙˆÛŒ Ø´Ø¯!");
        document.getElementById('winner-text').innerText = msg;
        document.getElementById('final-scores').innerText = `${p1Name}: ${scores.X} | ${p2Name}: ${scores.O}`;
        showScreen('result-screen');
        if(currentRoomId && gameMode === "online") await supabaseClient.from('rooms').update({ is_active: false }).eq('id', currentRoomId);
    }

    function checkWinner(b) {
        const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
        for(let c of wins) if(b[c[0]] && b[c[0]]===b[c[1]] && b[c[0]]===b[c[2]]) return b[c[0]];
        return null;
    }

    function renderBoard() {
        const cells = document.querySelectorAll('.cell');
        board.forEach((v, i) => { 
            cells[i].innerText = v; 
            cells[i].className = `cell ${v.toLowerCase()}`; 
        });
        document.getElementById('p1-score').innerText = scores.X;
        document.getElementById('p2-score').innerText = scores.O;
        document.getElementById('p1-name-display').innerText = p1Name || "Ù…ÛŒØ²Ø¨Ø§Ù†";
        document.getElementById('p2-name-display').innerText = p2Name || "Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±...";
        document.getElementById('round-info').innerText = `Ø±Ø§Ù†Ø¯: ${Math.min(rounds, 5)} / 5`;
        
        const turnDisplay = (currentPlayer === mySymbol && gameMode === "online") ? "Ù†ÙˆØ¨Øª Ø´Ù…Ø§Ø³Øª" : `Ù†ÙˆØ¨Øª ${currentPlayer === "X" ? p1Name : (p2Name || "Ø­Ø±ÛŒÙ")}`;
        document.getElementById('game-status').innerText = turnDisplay;
    }

    // --- Ø­Ø§Ù„Øªâ€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± ---
    function startOffline() { gameMode = "offline"; p1Name = "Ø¨Ø§Ø²ÛŒÚ©Ù† Û±"; p2Name = "Ø¨Ø§Ø²ÛŒÚ©Ù† Û²"; showScreen('game-screen'); renderBoard(); }
    function showAiLevels() { gameMode = "ai"; p1Name = currentUser; p2Name = "Ø±Ø¨Ø§Øª"; showScreen('game-screen'); renderBoard(); }
    function makeAiMove() { 
        let empty = board.map((v,i)=>v===""?i:null).filter(v=>v!==null);
        if(empty.length && rounds <= 5) handleMove(empty[Math.floor(Math.random()*empty.length)]);
    }
</script>
</body>
</html>
