<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯ÙˆØ² Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ†</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #6366f1; --secondary: #ec4899; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; }
        * { box-sizing: border-box; transition: all 0.2s ease; font-family: 'Segoe UI', Tahoma, sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden; }
        .container { width: 95%; max-width: 450px; background: var(--card); padding: 25px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 1px solid #334155; text-align: center; position: relative; }
        .hidden { display: none !important; }
        input { width: 100%; padding: 15px; margin: 15px 0; border-radius: 12px; border: 2px solid #334155; background: #0f172a; color: white; font-size: 1rem; text-align: center; }
        .menu-btn { width: 100%; padding: 16px; margin: 8px 0; border: none; border-radius: 14px; background: var(--primary); color: white; font-size: 1.1rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .menu-btn:hover { filter: brightness(1.1); transform: translateY(-2px); }
        .board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0; }
        .cell { aspect-ratio: 1; background: #334155; border-radius: 16px; display: flex; justify-content: center; align-items: center; font-size: 2.5rem; font-weight: 800; cursor: pointer; height: 90px; }
        .cell.x { color: #60a5fa; text-shadow: 0 0 10px #60a5fa; }
        .cell.o { color: #f472b6; text-shadow: 0 0 10px #f472b6; }
        .status-bar { display: flex; justify-content: space-between; align-items: center; background: #0f172a; padding: 10px; border-radius: 15px; margin-bottom: 10px; border: 1px solid #334155; font-size: 0.8rem; }
        .room-item { background: #0f172a; padding: 10px; margin: 8px 0; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #475569; }
        #result-overlay { position: absolute; inset: 0; background: rgba(15, 23, 42, 0.98); border-radius: 24px; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; padding: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div id="login-screen">
        <h2>ğŸ® Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯</h2>
        <input type="text" id="username-input" placeholder="Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯...">
        <button class="menu-btn" onclick="login()">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¨Ø§Ø²ÛŒ</button>
    </div>

    <div id="menu-screen" class="hidden">
        <h3 id="welcome-msg"></h3>
        <button class="menu-btn" onclick="openLobby()" style="background: #6366f1;">ğŸŒ Ø¨Ø§Ø²ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ†</button>
        <button class="menu-btn" onclick="startOffline()" style="background: #10b981;">ğŸ‘¥ Ø¨Ø§Ø²ÛŒ Ø¢ÙÙ„Ø§ÛŒÙ†</button>
        <button class="menu-btn" onclick="showAiLevels()" style="background: #f59e0b;">ğŸ¤– Ø¨Ø§Ø²ÛŒ Ø¨Ø§ Ø±Ø¨Ø§Øª</button>
        <button onclick="clearUser()" style="background:none; border:none; color:#64748b; margin-top:10px; cursor:pointer; font-size: 0.8rem;">ğŸ”„ ØªØºÛŒÛŒØ± Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</button>
    </div>

    <div id="lobby-screen" class="hidden">
        <h3>Ø§ØªØ§Ù‚â€ŒÙ‡Ø§ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ†</h3>
        <div id="room-list" style="max-height: 250px; overflow-y: auto;"></div>
        <button class="menu-btn" onclick="createOnlineRoom()">â• Ø³Ø§Ø®Øª Ø§ØªØ§Ù‚ Ø¬Ø¯ÛŒØ¯</button>
        <button class="menu-btn" onclick="showScreen('menu-screen')" style="background:#475569">Ø¨Ø±Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†Ùˆ</button>
    </div>

    <div id="game-screen" class="hidden">
        <div style="font-size: 0.8rem; color: #fbbf24; margin-bottom:5px;">â³ Ø²Ù…Ø§Ù†: <span id="sec">30</span> Ø«Ø§Ù†ÛŒÙ‡</div>
        <div class="status-bar">
            <div><small id="p1-name-display"></small><br><span id="p1-score" style="font-size:1.2rem">0</span></div>
            <div id="game-status" style="color:var(--primary); font-weight: bold;">...</div>
            <div><small id="p2-name-display"></small><br><span id="p2-score" style="font-size:1.2rem">0</span></div>
        </div>
        <div class="board" id="board">
            <div class="cell" onclick="handleMove(0)"></div><div class="cell" onclick="handleMove(1)"></div><div class="cell" onclick="handleMove(2)"></div>
            <div class="cell" onclick="handleMove(3)"></div><div class="cell" onclick="handleMove(4)"></div><div class="cell" onclick="handleMove(5)"></div>
            <div class="cell" onclick="handleMove(6)"></div><div class="cell" onclick="handleMove(7)"></div><div class="cell" onclick="handleMove(8)"></div>
        </div>
        <div id="round-info" style="font-weight:bold;">Ø±Ø§Ù†Ø¯: 1 / 5</div>
        <button class="menu-btn" onclick="exitCurrentGame()" style="background:#ef4444; margin-top: 10px; font-size: 0.8rem; padding: 10px;">ğŸšª Ø®Ø±ÙˆØ¬ Ø§Ø² Ø§ØªØ§Ù‚</button>
    </div>

    <div id="result-screen" class="hidden">
        <div id="result-overlay">
            <h2 id="winner-text" style="color: var(--secondary);"></h2>
            <div id="final-scores" style="font-size: 1.1rem; margin-bottom: 20px;"></div>
            <button class="menu-btn" onclick="showScreen('menu-screen')">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†Ùˆ</button>
        </div>
    </div>
</div>

<script>
    const SB_URL = 'https://kbtvvcbgnvohlxncfjdu.supabase.co';
    const SB_KEY = 'sb_publishable_1S4Ogjebi8k6P7VJZ3te4g_cmub4ub9';
    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

    let currentUser = "", gameMode = "", board = Array(9).fill(""), currentPlayer = "X";
    let scores = { X: 0, O: 0 }, rounds = 1, currentRoomId = null, mySymbol = "X", moveTimer = null;
    let p1Name = "", p2Name = "", lobbyInterval = null, currentSub = null;

    // Ú†Ú© Ú©Ø±Ø¯Ù† Ù†Ø§Ù… Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡
    window.onload = () => {
        const saved = JSON.parse(localStorage.getItem('user_session'));
        if (saved && (new Date().getTime() - saved.timestamp < 24 * 60 * 60 * 1000)) {
            currentUser = saved.name;
            showScreen('menu-screen');
            document.getElementById('welcome-msg').innerText = `Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØŒ ${currentUser}`;
        }
    };

    function login() {
        const val = document.getElementById('username-input').value.trim();
        if(!val) return alert("Ù†Ø§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
        currentUser = val;
        localStorage.setItem('user_session', JSON.stringify({ name: val, timestamp: new Date().getTime() }));
        showScreen('menu-screen');
        document.getElementById('welcome-msg').innerText = `Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØŒ ${currentUser}`;
    }

    function clearUser() {
        localStorage.removeItem('user_session');
        location.reload();
    }

    function showScreen(id) {
        document.querySelectorAll('.container > div').forEach(d => d.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        clearInterval(lobbyInterval);
        if (id === 'menu-screen') resetGameState();
    }

    function resetGameState() {
        clearInterval(moveTimer);
        if(currentSub) currentSub.unsubscribe();
        currentRoomId = null;
        board = Array(9).fill("");
        scores = {X:0, O:0};
        rounds = 1;
        currentPlayer = "X";
    }

    async function exitCurrentGame() {
        if (gameMode === "online" && currentRoomId) {
            await supabaseClient.from('rooms').update({ is_active: false }).eq('id', currentRoomId);
        }
        showScreen('menu-screen');
    }

    function openLobby() {
        showScreen('lobby-screen');
        fetchRooms();
        lobbyInterval = setInterval(fetchRooms, 5000);
    }

    async function fetchRooms() {
        const { data } = await supabaseClient.from('rooms').select('*').eq('is_active', true).is('player2_name', null);
        const list = document.getElementById('room-list');
        list.innerHTML = (data && data.length) ? "" : "<p style='color:#64748b; padding:15px;'>Ø§ØªØ§Ù‚ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯...</p>";
        data?.forEach(r => {
            list.innerHTML += `<div class="room-item">
                <span><b>${r.room_code}</b> - <small>${r.player1_name}</small></span>
                <button class="menu-btn" style="width:60px; padding:5px; font-size:0.7rem; background:#10b981;" onclick="joinRoom('${r.id}')">ÙˆØ±ÙˆØ¯</button>
            </div>`;
        });
    }

    async function createOnlineRoom() {
        const code = Math.floor(1000 + Math.random() * 9000).toString();
        const { data } = await supabaseClient.from('rooms').insert([{ 
            player1_name: currentUser, room_code: code, board: Array(9).fill(""), turn: "X", scores: {X:0, O:0}, is_active: true
        }]).select();
        if(data) { currentRoomId = data[0].id; mySymbol = "X"; p1Name = currentUser; setupOnline(); }
    }

    async function joinRoom(id) {
        const { data } = await supabaseClient.from('rooms').update({ player2_name: currentUser }).eq('id', id).select();
        if(data) { currentRoomId = id; mySymbol = "O"; p1Name = data[0].player1_name; p2Name = currentUser; setupOnline(); }
    }

    function setupOnline() {
        gameMode = "online";
        showScreen('game-screen');
        renderBoard();
        currentSub = supabaseClient.channel(`room:${currentRoomId}`)
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'rooms', filter: `id=eq.${currentRoomId}` }, payload => {
                const d = payload.new;
                if(!d.is_active) { alert("Ø§ØªØ§Ù‚ Ø¨Ø³ØªÙ‡ Ø´Ø¯."); showScreen('menu-screen'); return; }
                board = d.board; currentPlayer = d.turn; scores = d.scores; rounds = d.rounds_played + 1;
                p1Name = d.player1_name; p2Name = d.player2_name;
                renderBoard();
                if(p2Name && currentPlayer === mySymbol) startTimer(); else clearInterval(moveTimer);
                if(rounds > 5) finalizeGame();
            }).subscribe();
    }

    async function handleMove(i) {
        if (board[i] !== "" || (gameMode === "online" && (currentPlayer !== mySymbol || !p2Name))) return;
        board[i] = currentPlayer;
        const win = checkWinner(board);
        if (win) { scores[win]++; rounds++; board = Array(9).fill(""); }
        else if (!board.includes("")) { rounds++; board = Array(9).fill(""); }
        currentPlayer = currentPlayer === "X" ? "O" : "X";
        if(gameMode === "online") {
            await supabaseClient.from('rooms').update({ board, turn: currentPlayer, scores, rounds_played: rounds-1 }).eq('id', currentRoomId);
        } else {
            renderBoard();
            if(gameMode === "ai" && currentPlayer === "O") setTimeout(makeAiMove, 600);
        }
    }

    function startTimer() {
        clearInterval(moveTimer);
        let s = 30; document.getElementById('sec').innerText = s;
        moveTimer = setInterval(async () => {
            s--; document.getElementById('sec').innerText = s;
            if(s <= 0) { clearInterval(moveTimer); finalizeGame(`Ø²Ù…Ø§Ù† ØªÙ…Ø§Ù… Ø´Ø¯! Ø¨Ø±Ù†Ø¯Ù‡: ${mySymbol==='X'?(p2Name||'Ø­Ø±ÛŒÙ'):p1Name}`); }
        }, 1000);
    }

    async function finalizeGame(msg = null) {
        clearInterval(moveTimer);
        if(!msg) msg = (scores.X > scores.O) ? `ğŸ† Ø¨Ø±Ù†Ø¯Ù‡: ${p1Name}` : (scores.O > scores.X ? `ğŸ† Ø¨Ø±Ù†Ø¯Ù‡: ${p2Name}` : "ğŸ¤ Ù…Ø³Ø§ÙˆÛŒ");
        document.getElementById('winner-text').innerText = msg;
        document.getElementById('final-scores').innerText = `${p1Name}: ${scores.X} | ${p2Name}: ${scores.O}`;
        showScreen('result-screen');
        if(currentRoomId && gameMode === "online") await supabaseClient.from('rooms').update({ is_active: false }).eq('id', currentRoomId);
    }

    function checkWinner(b) {
        const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
        for(let c of wins) if(b[c[0]] && b[c[0]]===b[c[1]] && b[c[0]]===b[c[2]]) return b[c[0]];
        return null;
    }

    function renderBoard() {
        const cells = document.querySelectorAll('.cell');
        board.forEach((v, i) => { cells[i].innerText = v; cells[i].className = `cell ${v.toLowerCase()}`; });
        document.getElementById('p1-score').innerText = scores.X;
        document.getElementById('p2-score').innerText = scores.O;
        document.getElementById('p1-name-display').innerText = p1Name || "Ø¨Ø§Ø²ÛŒÚ©Ù† Û±";
        document.getElementById('p2-name-display').innerText = p2Name || "Ø§Ù†ØªØ¸Ø§Ø±...";
        document.getElementById('round-info').innerText = `Ø±Ø§Ù†Ø¯: ${Math.min(rounds, 5)} / 5`;
        document.getElementById('game-status').innerText = (currentPlayer === "X" ? p1Name : (p2Name || "Ø­Ø±ÛŒÙ"));
    }

    function startOffline() { gameMode = "offline"; p1Name = "Ù…ÛŒØ²Ø¨Ø§Ù†"; p2Name = "Ù…Ù‡Ù…Ø§Ù†"; showScreen('game-screen'); renderBoard(); }
    function showAiLevels() { gameMode = "ai"; p1Name = currentUser; p2Name = "Ø±Ø¨Ø§Øª"; showScreen('game-screen'); renderBoard(); }
    function makeAiMove() { 
        let empty = board.map((v,i)=>v===""?i:null).filter(v=>v!==null);
        if(empty.length && rounds <= 5) handleMove(empty[Math.floor(Math.random()*empty.length)]);
    }
</script>
</body>
</html>
